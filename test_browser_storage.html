<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser Storage Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    h2 {
      color: #666;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #da190b;
    }
    button.secondary {
      background: #2196F3;
    }
    button.secondary:hover {
      background: #0b7dda;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .test-result.pass {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .test-result.fail {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .test-result.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .storage-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ§ª Browser Storage Test Suite</h1>
    <p>This page tests localStorage persistence across page reloads.</p>
    
    <div class="storage-info">
      <strong>Storage Keys:</strong>
      <ul>
        <li><code>finance-simulation-config</code> - New format with transitions</li>
        <li><code>finance-simulation-parameters</code> - Legacy format</li>
      </ul>
    </div>
  </div>

  <div class="container">
    <h2>Controls</h2>
    <div class="controls">
      <button onclick="runAllTests()">Run All Tests</button>
      <button class="secondary" onclick="inspectStorage()">Inspect Storage</button>
      <button class="secondary" onclick="testReloadPersistence()">Test Reload Persistence</button>
      <button class="danger" onclick="clearAllStorage()">Clear All Storage</button>
      <button class="secondary" onclick="location.reload()">Reload Page</button>
    </div>
  </div>

  <div class="container">
    <h2>Test Results</h2>
    <div id="results"></div>
  </div>

  <div class="container">
    <h2>Storage Contents</h2>
    <div id="storage-contents"></div>
  </div>

  <script type="module">
    const STORAGE_KEY = "finance-simulation-config";
    const LEGACY_KEY = "finance-simulation-parameters";

    // Test utilities
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.textContent = message;
      results.appendChild(div);
      console.log(message);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    // Create test configuration
    function createTestConfig(age = 30) {
      return {
        version: "2.0",
        baseParameters: {
          householdMode: "single",
          people: [{
            id: "person-1",
            name: "Test Person",
            currentAge: age,
            retirementAge: 65,
            incomeSources: [{
              id: "income-1",
              label: "Salary",
              amount: 80000,
              frequency: "yearly",
              isBeforeTax: true,
            }],
            superAccounts: [],
          }],
          loans: [],
          expenseItems: [{
            id: "expense-1",
            label: "Test Expense",
            amount: 100,
            frequency: "monthly",
            category: "living",
          }],
          // Legacy fields
          annualSalary: 80000,
          salaryFrequency: "monthly",
          incomeTaxRate: 30,
          monthlyLivingExpenses: 0,
          monthlyRentOrMortgage: 0,
          loanPrincipal: 0,
          loanInterestRate: 0,
          loanPaymentAmount: 0,
          loanPaymentFrequency: "monthly",
          useOffsetAccount: false,
          currentOffsetBalance: 0,
          monthlyInvestmentContribution: 500,
          investmentReturnRate: 7,
          currentInvestmentBalance: 10000,
          superContributionRate: 11,
          superReturnRate: 7,
          currentSuperBalance: 0,
          desiredAnnualRetirementIncome: 60000,
          retirementAge: 65,
          currentAge: age,
          simulationYears: 40,
          startDate: new Date("2024-01-01").toISOString(),
        },
        transitions: [],
        savedAt: new Date().toISOString(),
      };
    }

    // Test 1: Basic save and load
    function testBasicSaveLoad() {
      log("Test 1: Basic save and load", "info");
      
      const config = createTestConfig(30);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      
      const loaded = JSON.parse(localStorage.getItem(STORAGE_KEY));
      
      if (loaded && loaded.baseParameters.currentAge === 30) {
        log("âœ… Basic save and load works", "pass");
        return true;
      } else {
        log("âŒ Basic save and load failed", "fail");
        return false;
      }
    }

    // Test 2: Age persistence
    function testAgePersistence() {
      log("Test 2: Age persistence", "info");
      
      const config = createTestConfig(42);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      
      const loaded = JSON.parse(localStorage.getItem(STORAGE_KEY));
      
      const legacyAge = loaded.baseParameters.currentAge;
      const personAge = loaded.baseParameters.people[0].currentAge;
      
      if (legacyAge === 42 && personAge === 42) {
        log(`âœ… Age persists correctly (legacy: ${legacyAge}, person: ${personAge})`, "pass");
        return true;
      } else {
        log(`âŒ Age persistence failed (legacy: ${legacyAge}, person: ${personAge})`, "fail");
        return false;
      }
    }

    // Test 3: Multiple updates
    function testMultipleUpdates() {
      log("Test 3: Multiple updates", "info");
      
      // Save initial
      let config = createTestConfig(25);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      
      // Update age
      config = JSON.parse(localStorage.getItem(STORAGE_KEY));
      config.baseParameters.currentAge = 26;
      config.baseParameters.people[0].currentAge = 26;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      
      // Update again
      config = JSON.parse(localStorage.getItem(STORAGE_KEY));
      config.baseParameters.currentAge = 27;
      config.baseParameters.people[0].currentAge = 27;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      
      // Verify
      const loaded = JSON.parse(localStorage.getItem(STORAGE_KEY));
      
      if (loaded.baseParameters.currentAge === 27 && 
          loaded.baseParameters.people[0].currentAge === 27) {
        log("âœ… Multiple updates work correctly", "pass");
        return true;
      } else {
        log("âŒ Multiple updates failed", "fail");
        return false;
      }
    }

    // Test 4: Expense persistence
    function testExpensePersistence() {
      log("Test 4: Expense persistence", "info");
      
      const config = createTestConfig(30);
      config.baseParameters.expenseItems.push({
        id: "expense-2",
        label: "Netflix",
        amount: 15,
        frequency: "monthly",
        category: "entertainment",
      });
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      const loaded = JSON.parse(localStorage.getItem(STORAGE_KEY));
      
      if (loaded.baseParameters.expenseItems.length === 2 &&
          loaded.baseParameters.expenseItems[1].label === "Netflix") {
        log("âœ… Expenses persist correctly", "pass");
        return true;
      } else {
        log("âŒ Expense persistence failed", "fail");
        return false;
      }
    }

    // Test 5: Transition persistence
    function testTransitionPersistence() {
      log("Test 5: Transition persistence", "info");
      
      const config = createTestConfig(30);
      config.transitions = [{
        id: "transition-1",
        transitionDate: new Date("2025-01-01").toISOString(),
        label: "Salary Increase",
        parameterChanges: {
          annualSalary: 90000,
        },
      }];
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      const loaded = JSON.parse(localStorage.getItem(STORAGE_KEY));
      
      if (loaded.transitions.length === 1 &&
          loaded.transitions[0].label === "Salary Increase") {
        log("âœ… Transitions persist correctly", "pass");
        return true;
      } else {
        log("âŒ Transition persistence failed", "fail");
        return false;
      }
    }

    // Test 6: Check if data survives page reload
    function testReloadPersistence() {
      log("Test 6: Reload persistence check", "info");
      
      const testData = {
        testId: Date.now(),
        age: 33,
        timestamp: new Date().toISOString(),
      };
      
      const config = createTestConfig(testData.age);
      config.testData = testData;
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      localStorage.setItem("test-reload-marker", JSON.stringify(testData));
      
      log(`ðŸ“ Saved test data with ID: ${testData.testId}`, "info");
      log("ðŸ”„ Please reload the page to verify persistence", "info");
      
      // Check if we're coming back from a reload
      const marker = localStorage.getItem("test-reload-marker");
      if (marker) {
        const markerData = JSON.parse(marker);
        const config = JSON.parse(localStorage.getItem(STORAGE_KEY));
        
        if (config && config.testData && config.testData.testId === markerData.testId) {
          log(`âœ… Data survived reload! Test ID: ${markerData.testId}`, "pass");
          log(`   Age: ${config.baseParameters.currentAge}`, "pass");
          log(`   Timestamp: ${markerData.timestamp}`, "pass");
          localStorage.removeItem("test-reload-marker");
          return true;
        } else {
          log("âŒ Data did not survive reload", "fail");
          return false;
        }
      }
    }

    // Test 7: Storage quota
    function testStorageQuota() {
      log("Test 7: Storage quota check", "info");
      
      try {
        const estimate = navigator.storage && navigator.storage.estimate 
          ? navigator.storage.estimate() 
          : Promise.resolve({ usage: 0, quota: 0 });
        
        estimate.then(({ usage, quota }) => {
          const usageInMB = (usage / (1024 * 1024)).toFixed(2);
          const quotaInMB = (quota / (1024 * 1024)).toFixed(2);
          const percentUsed = quota > 0 ? ((usage / quota) * 100).toFixed(2) : 0;
          
          log(`ðŸ“Š Storage usage: ${usageInMB} MB / ${quotaInMB} MB (${percentUsed}%)`, "info");
          
          if (percentUsed < 80) {
            log("âœ… Storage quota is healthy", "pass");
          } else {
            log("âš ï¸  Storage quota is getting high", "fail");
          }
        });
      } catch (error) {
        log("âš ï¸  Could not check storage quota", "info");
      }
    }

    // Inspect current storage
    window.inspectStorage = function() {
      const contents = document.getElementById('storage-contents');
      contents.innerHTML = '';
      
      const config = localStorage.getItem(STORAGE_KEY);
      const legacy = localStorage.getItem(LEGACY_KEY);
      
      if (config) {
        const parsed = JSON.parse(config);
        const pre = document.createElement('pre');
        pre.textContent = `Config (${STORAGE_KEY}):\n${JSON.stringify(parsed, null, 2)}`;
        contents.appendChild(pre);
      } else {
        contents.innerHTML += '<p>No config found in storage</p>';
      }
      
      if (legacy) {
        const parsed = JSON.parse(legacy);
        const pre = document.createElement('pre');
        pre.textContent = `Legacy (${LEGACY_KEY}):\n${JSON.stringify(parsed, null, 2)}`;
        contents.appendChild(pre);
      }
      
      // Show all localStorage keys
      const allKeys = Object.keys(localStorage);
      if (allKeys.length > 0) {
        const div = document.createElement('div');
        div.innerHTML = `<h3>All Storage Keys (${allKeys.length}):</h3>`;
        const ul = document.createElement('ul');
        allKeys.forEach(key => {
          const li = document.createElement('li');
          const size = localStorage.getItem(key).length;
          li.textContent = `${key} (${size} bytes)`;
          ul.appendChild(li);
        });
        div.appendChild(ul);
        contents.appendChild(div);
      }
    };

    // Clear all storage
    window.clearAllStorage = function() {
      if (confirm('Are you sure you want to clear all localStorage?')) {
        localStorage.clear();
        clearResults();
        log("ðŸ—‘ï¸  All storage cleared", "info");
        inspectStorage();
      }
    };

    // Run all tests
    window.runAllTests = function() {
      clearResults();
      log("=== Running Browser Storage Tests ===", "info");
      
      let passed = 0;
      let failed = 0;
      
      if (testBasicSaveLoad()) passed++; else failed++;
      if (testAgePersistence()) passed++; else failed++;
      if (testMultipleUpdates()) passed++; else failed++;
      if (testExpensePersistence()) passed++; else failed++;
      if (testTransitionPersistence()) passed++; else failed++;
      testReloadPersistence(); // Special case
      testStorageQuota();
      
      log(`\n=== Summary: ${passed} passed, ${failed} failed ===`, 
           failed === 0 ? "pass" : "fail");
      
      inspectStorage();
    };

    // Auto-run on page load
    window.addEventListener('load', () => {
      log("ðŸš€ Page loaded", "info");
      testReloadPersistence();
      inspectStorage();
    });

    // Make functions available globally
    window.testReloadPersistence = testReloadPersistence;
  </script>
</body>
</html>
